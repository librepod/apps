apiVersion: batch/v1
kind: Job
metadata:
  name: job-step-certificates-persistent
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  # The property `ttlSecondsAfterFinished` allows to delete the job automatically
  # after a specified period. But in our case ArgoCD will take care of
  # deletion of this job. We leave this param just in case.
  ttlSecondsAfterFinished: 10
  backoffLimit: 0
  parallelism: 1
  completions: 1
  template:
    metadata:
      name: job-step-certificates-persistent
    spec:
      restartPolicy: Never
      containers:
      - image: cr.smallstep.com/smallstep/step-ca
        imagePullPolicy: IfNotPresent
        name: job-step-certificates-persistent
        command: ["/bin/bash", "/scripts/step-ca-bootstrap-persistent.sh"]
        envFrom:
          - configMapRef:
              name: cm-step-ca-bootstrap-persistent
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            add:
            - NET_BIND_SERVICE
            drop:
            - ALL
          readOnlyRootFilesystem: false  # Need write access to PVC
          runAsNonRoot: true
          runAsUser: 1000
        volumeMounts:
          - mountPath: /scripts
            name: entrypoint
            readOnly: true
          - mountPath: /home/step
            name: ca-data
      dnsPolicy: ClusterFirst
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: step-ca-bootstrap-persistent
      volumes:
        - name: entrypoint
          configMap:
            name: cm-step-ca-bootstrap-persistent-script
            items:
              - key: step-ca-bootstrap-persistent.sh
                path: step-ca-bootstrap-persistent.sh
        - name: ca-data
          persistentVolumeClaim:
            claimName: step-certificates-data
