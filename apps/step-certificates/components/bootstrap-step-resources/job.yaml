apiVersion: batch/v1
kind: Job
metadata:
  name: job-step-ca-bootstrap-resources
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    argocd.argoproj.io/sync-wave: "5"
spec:
  # The property `ttlSecondsAfterFinished` allows to delete the job automatically
  # after a specified period. But in our case ArgoCD will take care of
  # deletion of this job. We leave this param just in case.
  ttlSecondsAfterFinished: 10
  backoffLimit: 0
  parallelism: 1
  completions: 1
  template:
    metadata:
      name: job-step-ca-bootstrap-resources
    spec:
      restartPolicy: Never
      # Init container to wait for CA to be ready before creating resources
      # The main pod initContainer initializes the CA, but we need to wait
      # for the CA server to actually start and be ready
      initContainers:
      - name: wait-for-ca
        image: cr.smallstep.com/smallstep/step-ca:0.29.0
        command:
          - sh
          - -c
          - |
            echo "Waiting for CA to be ready at https://step-certificates.step-ca.svc.cluster.local:9000..."
            for i in $(seq 1 60); do
              if curl -fk -s https://step-certificates.step-ca.svc.cluster.local:9000/health | grep -q "ok"; then
                echo "CA is ready, proceeding with resource creation."
                exit 0
              fi
              echo "Waiting... ($i/60)"
              sleep 5
            done
            echo "Timeout waiting for CA to be ready"
            exit 1
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
      containers:
      - image: cr.smallstep.com/smallstep/step-ca
        imagePullPolicy: IfNotPresent
        name: job-step-ca-bootstrap-resources
        command: ["/bin/bash", "/scripts/step-ca-bootstrap-resources.sh"]
        envFrom:
          - configMapRef:
              name: cm-step-ca-bootstrap-resources
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          runAsNonRoot: true
          runAsUser: 1000
        volumeMounts:
          - mountPath: /scripts
            name: entrypoint
            readOnly: true
          - mountPath: /home/step
            name: ca-data
            readOnly: true
          - mountPath: /tmp
            name: tmp
      dnsPolicy: ClusterFirst
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: step-ca-bootstrap-step-issuer
      volumes:
        - name: entrypoint
          configMap:
            name: cm-step-ca-bootstrap-resources-script
            items:
              - key: step-ca-bootstrap-resources.sh
                path: step-ca-bootstrap-resources.sh
        - name: ca-data
          persistentVolumeClaim:
            claimName: step-certificates-data
        - name: tmp
          emptyDir: {}
