apiVersion: batch/v1
kind: Job
metadata:
  name: job-step-ca-bootstrap-cluster-issuer
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    argocd.argoproj.io/sync-wave: "5"
spec:
  # The property `ttlSecondsAfterFinished` allows to delete the job automatically
  # after a specified period. But in our case ArgoCD will take care of
  # deletion of this job. We leave this param just in case.
  ttlSecondsAfterFinished: 10
  backoffLimit: 0
  parallelism: 1
  completions: 1
  template:
    metadata:
      name: job-step-ca-bootstrap-cluster-issuer
    spec:
      restartPolicy: Never
      containers:
      - image: cr.smallstep.com/smallstep/step-ca
        imagePullPolicy: IfNotPresent
        name: job-step-ca-bootstrap-cluster-issuer
        command: ["/bin/bash", "/scripts/step-ca-bootstrap-cluster-issuer.sh"]
        envFrom:
          - configMapRef:
              name: cm-step-ca-bootstrap-cluster-issuer
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          runAsNonRoot: true
          runAsUser: 1000
        volumeMounts:
          - mountPath: /scripts
            name: entrypoint
            readOnly: true
          - mountPath: /home/step
            name: ca-data
            readOnly: true
          - mountPath: /tmp
            name: tmp
      dnsPolicy: ClusterFirst
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: step-ca-bootstrap-cluster-issuer
      volumes:
        - name: entrypoint
          configMap:
            name: cm-step-ca-bootstrap-cluster-issuer-script
            items:
              - key: step-ca-bootstrap-cluster-issuer.sh
                path: step-ca-bootstrap-cluster-issuer.sh
        - name: ca-data
          persistentVolumeClaim:
            claimName: step-certificates-data
        - name: tmp
          emptyDir: {}
